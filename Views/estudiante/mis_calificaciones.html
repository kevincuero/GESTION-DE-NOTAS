<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Calificaciones</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estudiante.css') }}">
    <style>
        /* Small page-specific tweaks (kept minimal to preserve shared stylesheet look) */
        .calificaciones-header { margin-bottom: 20px; color: #2d3142; }
        .filter-row { display:flex; gap:10px; align-items:center; margin-bottom:18px; flex-wrap: wrap; }
        .filter-row input[type="search"] { padding:8px 12px; border-radius:6px; border:1px solid #ddd; flex:1; min-width:200px; }
        .download-btn { background:#4facfe; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; white-space:nowrap; }
        .filter-select { padding:8px 12px; border-radius:6px; border:1px solid #ddd; min-width:200px; }
        
        /* Estilos para cards de materias */
        .materias-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .materia-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            padding: 20px;
            border-left: 5px solid #4361ee;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .materia-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .materia-card.oculto { display: none; }
        .materia-title { 
            font-size: 1.3rem; 
            font-weight: bold; 
            color: #4361ee; 
            margin-bottom: 15px;
            border-bottom: 2px solid #e9eefb;
            padding-bottom: 10px;
        }
        .evaluacion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .evaluacion-item:last-child { border-bottom: none; }
        .evaluacion-tipo {
            font-weight: 500;
            color: #2d3142;
            flex: 1;
        }
        .evaluacion-nota {
            background: #4361ee;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            margin-right: 10px;
        }
        .evaluacion-comentario {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #ddd;
        }
        .promedio-materia {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid #4361ee;
        }
        .promedio-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        .promedio-valor {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4361ee;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    {% set active_page = 'calificaciones' %}
    {% include 'estudiante/_sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <h1 class="calificaciones-header">Mis Calificaciones</h1>

        <!-- Filtros: bÃºsqueda + materias inscritas -->
        <div class="filter-row">
            <input id="searchMateria" type="search" placeholder="Buscar por materia..." />
            <select id="materiaSelect" class="filter-select">
                <option value="">-- Todas las materias inscritas --</option>
                {# Opciones Ãºnicas por materia inscrita #}
                {% set materias_unicas = [] %}
                {% for materia_grupo in materias_agrupadas %}
                    {% set _ = materias_unicas.append(materia_grupo.nombre) %}
                    <option value="{{ materia_grupo.nombre }}">{{ materia_grupo.nombre }}</option>
                {% endfor %}
            </select>
            <a id="downloadCsv" class="download-btn" href="{{ url_for('descargar_calificaciones') }}">Descargar CSV</a>
        </div>

        <!-- Cards de Materias Agrupadas -->
        <div class="materias-container" id="materiasContainer">
            {% if materias_agrupadas %}
                {% for materia_grupo in materias_agrupadas %}
                <div class="materia-card" data-materia="{{ materia_grupo.nombre }}">
                    <div class="materia-title">{{ materia_grupo.nombre }}</div>
                    
                    {% for nota in materia_grupo.notas %}
                    <div class="evaluacion-item">
                        <div class="evaluacion-tipo">{{ nota.tipo_evaluacion }}</div>
                        <div class="evaluacion-nota">{{ nota.nota }}</div>
                    </div>
                    {% if nota.comentario %}
                    <div class="evaluacion-comentario">{{ nota.comentario }}</div>
                    {% endif %}
                    {% endfor %}
                    
                    <!-- Promedio de la materia -->
                    <div class="promedio-materia">
                        <div class="promedio-label">Promedio en {{ materia_grupo.nombre }}</div>
                        <div class="promedio-valor" data-materia-id="{{ materia_grupo.materia_id }}">Calculando...</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <p style="color:#777; grid-column: 1/-1; text-align: center; padding: 40px;">No hay calificaciones para mostrar.</p>
            {% endif %}
        </div>

        <!-- Averaging Calculator Panel -->
        <div class="avg-panel" id="avgPanel">
            <div class="section-header">
                <h2 style="margin:0;">Calculadora de Promedio</h2>
                <div class="section-actions">
                    <button class="small-btn primary" id="addRowBtn">Agregar fila</button>
                    <button class="small-btn" id="importBtn">Importar calificaciones actuales</button>
                </div>
            </div>

            <div class="avg-rows" id="avgRows">
                <div class="avg-row">
                    <input type="number" step="0.01" class="nota-input avg-nota" placeholder="Nota (0-5)" min="0" max="5">
                    <input type="number" step="0.1" class="avg-pct pct" placeholder="% del parcial" min="0" max="100">
                    <button class="small-btn danger" type="button" onclick="removeRow(this)">Eliminar</button>
                </div>
            </div>

            <div class="avg-actions">
                <button class="small-btn primary" id="calcBtn">Calcular</button>
                <button class="small-btn" id="clearBtn">Limpiar</button>
            </div>

            <div class="promedio-result" id="avgResult" style="display:none;">
                <div class="modo-promedio" style="font-size:0.95rem; color:#666; margin-bottom:10px; padding:8px; background:#f0f7ff; border-radius:6px; border-left:3px solid #4361ee;">ðŸ“Š Modo: GENERAL</div>
                <div class="promedio-label">Promedio actual</div>
                <div class="promedio-value" id="promedioValue">0.00</div>
                <div class="required-grade" id="requiredText"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Keep sidebar active class in sync
            const active = '{{ active_page }}';
            const link = document.querySelector('.sidebar-link[href*="calificaciones"]');
            if (link) link.classList.add('active');

            // Filtros: bÃºsqueda por texto y select de materias inscritas
            const search = document.getElementById('searchMateria');
            const materiaSelect = document.getElementById('materiaSelect');
            const materiasContainer = document.getElementById('materiasContainer');

            function aplicarFiltros(){
                const q = (search?.value || '').toLowerCase();
                const selected = (materiaSelect?.value || '').toLowerCase();
                
                document.querySelectorAll('.materia-card').forEach(card => {
                    const materia = card.getAttribute('data-materia').toLowerCase();
                    const matchTexto = materia.includes(q);
                    const matchSelect = !selected || materia === selected;
                    card.classList.toggle('oculto', !(matchTexto && matchSelect));
                });
            }

            if (search) search.addEventListener('input', aplicarFiltros);
            if (materiaSelect) materiaSelect.addEventListener('change', aplicarFiltros);

            // Calcular promedios por materia
            function calcularPromedios() {
                document.querySelectorAll('.materia-card').forEach(card => {
                    const notas = [];
                    card.querySelectorAll('.evaluacion-nota').forEach(el => {
                        const nota = parseFloat(el.textContent);
                        if (!isNaN(nota)) notas.push(nota);
                    });
                    
                    if (notas.length > 0) {
                        const promedio = (notas.reduce((a, b) => a + b, 0) / notas.length).toFixed(2);
                        const promedioEl = card.querySelector('.promedio-valor');
                        promedioEl.textContent = promedio;
                    }
                });
            }
            calcularPromedios();

            // Averaging calculator logic
            const avgRows = document.getElementById('avgRows');
            const addRowBtn = document.getElementById('addRowBtn');
            const importBtn = document.getElementById('importBtn');
            const calcBtn = document.getElementById('calcBtn');
            const clearBtn = document.getElementById('clearBtn');
            const avgResult = document.getElementById('avgResult');
            const promedioValue = document.getElementById('promedioValue');
            const requiredText = document.getElementById('requiredText');

            function removeRow(btn) {
                const row = btn.closest('.avg-row');
                if (row && avgRows.children.length > 1) row.remove();
                else {
                    row.querySelector('.avg-nota').value = '';
                    row.querySelector('.avg-pct').value = '';
                }
            }

            function addRow(nota='', pct=''){
                const div = document.createElement('div');
                div.className = 'avg-row';
                div.innerHTML = `<input type="number" step="0.01" class="nota-input avg-nota" placeholder="Nota (0-5)" min="0" max="5" value="${nota}">` +
                                `<input type="number" step="0.1" class="avg-pct pct" placeholder="% del parcial" min="0" max="100" value="${pct}">` +
                                `<button class="small-btn danger" type="button" onclick="removeRow(this)">Eliminar</button>`;
                avgRows.appendChild(div);
            }

            // expose removeRow to global scope so inline onclick works
            window.removeRow = removeRow;

            addRowBtn.addEventListener('click', function(){ addRow(); });

            // ========================
            // MODO DE IMPORTACIÃ“N - DOS FORMAS
            // ========================
            importBtn.addEventListener('click', function(){
                const selected = (materiaSelect?.value || '').toLowerCase();
                
                // MODO 1: Si hay una materia seleccionada especÃ­fica
                if (selected) {
                    const notas = [];
                    document.querySelectorAll('.materia-card:not(.oculto) .evaluacion-nota').forEach(el => {
                        const notaVal = parseFloat(el.textContent);
                        if (!isNaN(notaVal)) notas.push(notaVal);
                    });
                    
                    if (!notas.length) {
                        alert('No hay calificaciones para la materia seleccionada.');
                        return;
                    }
                    
                    avgRows.innerHTML = '';
                    notas.forEach(nota => addRow(nota, ''));
                    alert(`âœ“ Modo MATERIA ESPECÃFICA\nSe importaron ${notas.length} notas de "${materiaSelect.value}"`);
                } 
                // MODO 2: Si NO hay materia seleccionada (todas las materias)
                else {
                    const notas = [];
                    document.querySelectorAll('.materia-card:not(.oculto) .evaluacion-nota').forEach(el => {
                        const notaVal = parseFloat(el.textContent);
                        if (!isNaN(notaVal)) notas.push(notaVal);
                    });
                    
                    if (!notas.length) {
                        alert('No hay calificaciones para importar.');
                        return;
                    }
                    
                    avgRows.innerHTML = '';
                    notas.forEach(nota => addRow(nota, ''));
                    alert(`âœ“ Modo GENERAL\nSe importaron ${notas.length} notas de TODAS las materias`);
                }
            });

            // ========================
            // CÃLCULO DE PROMEDIO CON INDICADOR DE MODO
            // ========================
            calcBtn.addEventListener('click', function(){
                const rows = document.querySelectorAll('#avgRows .avg-row');
                let weightedSum = 0;
                let sumPct = 0;
                let countNotas = 0;
                
                rows.forEach(r => {
                    const n = parseFloat(r.querySelector('.avg-nota').value);
                    const p = parseFloat(r.querySelector('.avg-pct').value);
                    if (!isNaN(n)) countNotas++;
                    if (!isNaN(n) && !isNaN(p)){
                        weightedSum += n * p;
                        sumPct += p;
                    }
                });
                
                let target = 3.0;
                let currentAvg = 0;
                let modo = '';
                
                // Determinar modo actual
                const selected = (materiaSelect?.value || '').toLowerCase();
                if (selected) {
                    modo = `MATERIA: "${materiaSelect.value}"`;
                } else {
                    modo = 'GENERAL (TODAS LAS MATERIAS)';
                }
                
                if (sumPct > 0) {
                    currentAvg = (weightedSum / sumPct);
                } else if (countNotas > 0) {
                    // fallback: simple average
                    let s=0; let c=0;
                    rows.forEach(r=>{ 
                        const n=parseFloat(r.querySelector('.avg-nota').value); 
                        if(!isNaN(n)){ s+=n; c++; }
                    });
                    currentAvg = c? (s/c) : 0;
                }
                
                promedioValue.textContent = currentAvg.toFixed(2);
                
                // Mostrar modo en resultado
                const modoIndicator = document.querySelector('.modo-promedio');
                if (modoIndicator) {
                    modoIndicator.textContent = `ðŸ“Š Modo: ${modo}`;
                }
                
                // compute required next grade
                const remainingPct = 100 - sumPct;
                if (sumPct >= 100){
                    // no remaining weight
                    if (currentAvg >= target) {
                        requiredText.innerHTML = `<span class="success-badge">Â¡Felicitaciones! Ya alcanzaste ${currentAvg.toFixed(2)}</span>`;
                    } else {
                        requiredText.textContent = 'No hay porcentaje disponible para mejorar el promedio con nuevas notas.';
                    }
                } else {
                    const needed = (target * 100 - weightedSum) / (remainingPct || 1);
                    if (needed <= 0) {
                        requiredText.innerHTML = `<span class="success-badge">Â¡Felicitaciones! Ya estÃ¡s en ${currentAvg.toFixed(2)}</span>`;
                    } else if (needed <= 5) {
                        requiredText.textContent = `Necesitas una nota de ${needed.toFixed(2)} en el ${remainingPct.toFixed(1)}% restante para llegar a ${target.toFixed(2)}.`;
                    } else {
                        requiredText.textContent = `NecesitarÃ­as ${needed.toFixed(2)}, lo cual es mayor al mÃ¡ximo (5.0). No es posible con el porcentaje restante.`;
                    }
                }
                avgResult.style.display = '';
            });

            clearBtn.addEventListener('click', function(){
                // reset to single empty row
                avgRows.innerHTML = '';
                addRow();
                avgResult.style.display = 'none';
            });

        });
    </script>
</body>
</html>
