<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Tareas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estudiante.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Tareas page styles */
        .tareas-header { margin-bottom: 20px; color: #2d3142; }
        .filter-row { display:flex; gap:10px; align-items:center; margin-bottom:18px; flex-wrap: wrap; }
        .filter-select { padding:8px 12px; border-radius:6px; border:1px solid #ddd; min-width:200px; }
        
        /* Tareas card layout (similar a calificaciones pero con estructura de tarea) */
        .tareas-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .tarea-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            padding: 20px;
            border-left: 5px solid #f59e0b;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .tarea-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .tarea-card.oculto { display: none; }
        
        .tarea-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 10px;
        }
        .tarea-title { 
            font-size: 1.1rem; 
            font-weight: bold; 
            color: #2d3142; 
            margin: 0;
            flex: 1;
        }
        .tarea-badge {
            background: #f59e0b;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .tarea-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        .meta-item { display: flex; align-items: center; gap: 6px; }
        .meta-icon { color: #f59e0b; font-size: 1rem; }
        
        .tarea-description {
            color: #555;
            line-height: 1.5;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
        }
        
        .tarea-status {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            border-left: 4px solid #4361ee;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .status-label { color: #666; font-weight: 500; }
        .status-value { font-weight: 600; color: #4361ee; }
        
        .status-pendiente {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .status-pendiente .status-value {
            color: #ef4444;
        }
        
        .status-hecho {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .status-hecho .status-value {
            color: #10b981;
        }
        
        .entrega-info {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }
        .entrega-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .entrega-archivo {
            flex: 1;
        }
        .entrega-nombre { font-weight: 500; color: #2d3142; font-size: 0.95rem; }
        .entrega-fecha { color: #666; font-size: 0.85rem; margin-top: 4px; }
        .entrega-botones {
            display: flex;
            gap: 6px;
        }
        .btn-pequeño {
            padding: 4px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .btn-editar-entrega {
            background: #f59e0b;
            color: white;
        }
        .btn-editar-entrega:hover { background: #d97706; }
        
        .btn-eliminar-entrega {
            background: #ef4444;
            color: white;
        }
        .btn-eliminar-entrega:hover { background: #dc2626; }
        
        .material-adjunto {
            background: #f9fafb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #e5e7eb;
        }
        .material-icon { color: #666; font-size: 1.2rem; }
        .material-info { flex: 1; }
        .material-name { font-weight: 500; color: #2d3142; font-size: 0.95rem; }
        .material-link {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .material-link:hover { background: #bfdbfe; }
        
        .tarea-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .tarea-btn {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .btn-subir {
            background: #4361ee;
            color: white;
        }
        .btn-subir:hover { background: #3753d1; }
        
        .btn-editar {
            background: #f59e0b;
            color: white;
        }
        .btn-editar:hover { background: #d97706; }
        
        .btn-eliminar {
            background: #ef4444;
            color: white;
        }
        .btn-eliminar:hover { background: #dc2626; }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-icon { font-size: 3rem; margin-bottom: 10px; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex !important;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .modal-content h2 {
            margin-top: 0;
            color: #2d3142;
        }
        .form-group {
            margin: 1.5rem 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2d3142;
            font-weight: 500;
        }
        .form-group input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    {% set active_page = 'tareas' %}
    {% include 'estudiante/_sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <h1 class="tareas-header"><i class="fas fa-tasks"></i> Mis Tareas</h1>

        <!-- Filtros: materias inscritas -->
        <div class="filter-row">
            <select id="materiaSelect" class="filter-select">
                <option value="">-- Todas las materias inscritas --</option>
                {% set materias_unicas = [] %}
                {% for tarea in tareas %}
                    {% if tarea.nombre_materia not in materias_unicas %}
                        {% set _ = materias_unicas.append(tarea.nombre_materia) %}
                        <option value="{{ tarea.nombre_materia }}">{{ tarea.nombre_materia }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Cards de Tareas por Materia -->
        <div class="tareas-container" id="tareasContainer">
            {% if tareas %}
                {% for tarea in tareas %}
                <div class="tarea-card" data-materia="{{ tarea.nombre_materia }}" data-id-tarea="{{ tarea.id }}">
                    <!-- Header con título y tipo -->
                    <div class="tarea-header">
                        <h3 class="tarea-title">{{ tarea.titulo }}</h3>
                        <span class="tarea-badge">{{ tarea.tipo_tarea }}</span>
                    </div>
                    
                    <!-- Metadata: materia, fecha, profesor -->
                    <div class="tarea-meta">
                        <div class="meta-item">
                            <span class="meta-icon"><i class="fas fa-book"></i></span>
                            <span>{{ tarea.nombre_materia }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon"><i class="fas fa-calendar-alt"></i></span>
                            <span>{{ tarea.fecha_entrega }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon"><i class="fas fa-user-tie"></i></span>
                            <span>{{ tarea.nombre_profesor }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon"><i class="fas fa-clock"></i></span>
                            <span id="tiempo-restante-{{ tarea.id }}">Calculando...</span>
                        </div>
                    </div>
                    
                    <!-- Descripción -->
                    {% if tarea.descripcion %}
                    <div class="tarea-description">{{ tarea.descripcion }}</div>
                    {% endif %}
                    
                    <!-- Estado de la entrega -->
                    <div class="tarea-status" id="status-{{ tarea.id }}">
                        <div>
                            <span class="status-label">Estado Tarea:</span>
                            <span class="status-value">Pendiente</span>
                        </div>
                        <div>
                            <span class="status-label">Mi Entrega:</span>
                            <span class="status-value status-entrega-{{ tarea.id }}">Sin enviar</span>
                        </div>
                    </div>
                    
                    <!-- Información de entrega (si existe) -->
                    <div class="entrega-info" id="entrega-{{ tarea.id }}" style="display:none;">
                        <div class="entrega-header">
                            <div class="entrega-archivo">
                                <div class="entrega-nombre" id="entrega-nombre-{{ tarea.id }}">archivo.pdf</div>
                                <div class="entrega-fecha" id="entrega-fecha-{{ tarea.id }}">Enviado hace 2 días</div>
                            </div>
                            <div class="entrega-botones">
                                <button class="btn-pequeño btn-editar-entrega" onclick="abrirEditarEntrega(this)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-pequeño btn-eliminar-entrega" onclick="eliminarEntrega(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Material adjunto descargable -->
                    {% if tarea.filename and tarea.ruta %}
                    <div class="material-adjunto">
                        <div class="material-icon"><i class="fas fa-file-pdf"></i></div>
                        <div class="material-info">
                            <div class="material-name">Material de apoyo</div>
                            <a href="{{ url_for('descargar_tarea_material', id_tarea=tarea.id) }}" class="material-link">
                                <i class="fas fa-download"></i> Descargar
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Acciones: Subir Entrega -->
                    <div class="tarea-actions">
                        <button class="tarea-btn btn-subir" type="button" onclick="abrirSubir(this)">
                            <i class="fas fa-upload"></i> Subir Entrega
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                <h3>No hay tareas disponibles</h3>
                <p>Cuando los profesores asignen tareas, aparecerán aquí.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal para Subir Entrega -->
    <div id="modalSubir" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fas fa-upload"></i> Subir Entrega</h2>
            <form id="formSubir" enctype="multipart/form-data">
                <input type="hidden" id="idTareaSubir" name="id_tarea">
                <div class="form-group">
                    <label for="archivoSubir">Archivo de entrega *</label>
                    <input type="file" id="archivoSubir" name="archivo" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="tarea-btn btn-subir">
                        <i class="fas fa-check"></i> Enviar
                    </button>
                    <button type="button" class="tarea-btn btn-eliminar" onclick="cerrarModal('modalSubir')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Entrega -->
    <div id="modalEditarEntrega" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Editar Entrega</h2>
            <form id="formEditarEntrega" enctype="multipart/form-data">
                <input type="hidden" id="idTareaEditar" name="id_tarea">
                <div class="form-group">
                    <label for="archivoEditar">Nuevo archivo (deja vacío para mantener el actual)</label>
                    <input type="file" id="archivoEditar" name="archivo">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="tarea-btn btn-subir">
                        <i class="fas fa-check"></i> Actualizar
                    </button>
                    <button type="button" class="tarea-btn btn-eliminar" onclick="cerrarModal('modalEditarEntrega')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Activar sidebar
            const link = document.querySelector('.sidebar-link[href*="tareas"]');
            if (link) link.classList.add('active');

            // Filtro por materia
            const materiaSelect = document.getElementById('materiaSelect');
            function aplicarFiltros(){
                const selected = (materiaSelect?.value || '').toLowerCase();
                document.querySelectorAll('.tarea-card').forEach(card => {
                    const materia = card.getAttribute('data-materia').toLowerCase();
                    const match = !selected || materia === selected;
                    card.classList.toggle('oculto', !match);
                });
            }
            if (materiaSelect) materiaSelect.addEventListener('change', aplicarFiltros);

            // Calcular tiempo restante para cada tarea
            function calcularTiemposRestantes() {
                document.querySelectorAll('.tarea-card').forEach(card => {
                    const fechaEl = card.querySelector('.meta-item:nth-child(2)');
                    const textoFecha = fechaEl ? fechaEl.textContent.trim() : '';
                    const fechaStr = textoFecha.split('\n')[1] || textoFecha;
                    
                    const partes = fechaStr.split(' ');
                    const fecha = new Date(partes[0] + ' 23:59:59');
                    const ahora = new Date();
                    const diffMs = fecha - ahora;
                    const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                    
                    let textoTiempo = '';
                    if (diffDias < 0) {
                        textoTiempo = 'Vencida';
                    } else if (diffDias === 0) {
                        textoTiempo = 'Hoy';
                    } else {
                        textoTiempo = diffDias + ' día' + (diffDias !== 1 ? 's' : '') + ' restantes';
                    }
                    
                    const tiempoEl = card.querySelector('[id^="tiempo-restante-"]');
                    if (tiempoEl) tiempoEl.textContent = textoTiempo;
                });
            }
            calcularTiemposRestantes();
        });

        // Funciones de modal y acciones
        function abrirSubir(btnElement) {
            const card = btnElement.closest('.tarea-card');
            const id_tarea = card.getAttribute('data-id-tarea');
            document.getElementById('idTareaSubir').value = id_tarea;
            document.getElementById('modalSubir').classList.add('active');
        }

        function abrirEditarEntrega(el_or_id) {
            let id_tarea = el_or_id;
            if (typeof el_or_id === 'object' && el_or_id !== null && typeof el_or_id.closest === 'function') {
                const card = el_or_id.closest('.tarea-card');
                id_tarea = card ? card.getAttribute('data-id-tarea') : id_tarea;
            }
            document.getElementById('idTareaEditar').value = id_tarea;
            document.getElementById('modalEditarEntrega').classList.add('active');
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function eliminarEntrega(el_or_id) {
            let id_tarea = el_or_id;
            let card = null;
            if (typeof el_or_id === 'object' && el_or_id !== null && typeof el_or_id.closest === 'function') {
                card = el_or_id.closest('.tarea-card');
                id_tarea = card ? card.getAttribute('data-id-tarea') : null;
            } else {
                card = document.querySelector(`[data-id-tarea="${id_tarea}"]`);
            }

            if (!id_tarea) {
                alert('ID de tarea inválido');
                return;
            }

            if (confirm('¿Estás seguro de que deseas eliminar esta entrega?')) {
                fetch('{{ url_for("eliminar_entrega") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id_tarea: id_tarea })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('Entrega eliminada correctamente.');
                        if (!card) card = document.querySelector(`[data-id-tarea="${id_tarea}"]`);
                        const entregaDiv = card ? card.querySelector(`#entrega-${id_tarea}`) : null;
                        const statusDiv = card ? card.querySelector(`#status-${id_tarea}`) : null;
                        if (entregaDiv) entregaDiv.style.display = 'none';
                        if (statusDiv) {
                            statusDiv.classList.remove('status-hecho');
                            statusDiv.classList.add('status-pendiente');
                            const statusSpan = statusDiv.querySelector('.status-entrega-' + id_tarea);
                            if (statusSpan) statusSpan.textContent = 'Sin enviar';
                        }
                    } else {
                        alert('Error: ' + (data.message || 'No se pudo eliminar la entrega'));
                    }
                })
                .catch(err => alert('Error: ' + err.message));
            }
        }

        // Enviar formulario de subida
        document.getElementById('formSubir').addEventListener('submit', function(e) {
            e.preventDefault();
            const fd = new FormData(this);
            fetch('{{ url_for("subir_entrega") }}', {
                method: 'POST',
                body: fd
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const id_tarea = fd.get('id_tarea');
                    const card = document.querySelector(`[data-id-tarea="${id_tarea}"]`);
                    
                    // Actualizar estado a "Hecho"
                    const statusDiv = card.querySelector(`#status-${id_tarea}`);
                    statusDiv.classList.remove('status-pendiente');
                    statusDiv.classList.add('status-hecho');
                    const statusSpan = statusDiv.querySelector('.status-entrega-' + id_tarea);
                    statusSpan.textContent = 'Enviado';
                    
                    // Mostrar información de entrega
                    const entregaDiv = card.querySelector(`#entrega-${id_tarea}`);
                    entregaDiv.style.display = 'block';
                    
                    alert('Entrega enviada correctamente.');
                    cerrarModal('modalSubir');
                    document.getElementById('formSubir').reset();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo enviar la entrega'));
                }
            })
            .catch(err => alert('Error: ' + err.message));
        });

        // Enviar formulario de edición
        document.getElementById('formEditarEntrega').addEventListener('submit', function(e) {
            e.preventDefault();
            const fd = new FormData(this);
            fetch('{{ url_for("editar_entrega") }}', {
                method: 'POST',
                body: fd
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Entrega actualizada correctamente.');
                    cerrarModal('modalEditarEntrega');
                    document.getElementById('formEditarEntrega').reset();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo actualizar la entrega'));
                }
            })
            .catch(err => alert('Error: ' + err.message));
        });

        // Cerrar modales al presionar ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
