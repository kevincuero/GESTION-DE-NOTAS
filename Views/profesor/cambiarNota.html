{% extends 'profesor/base.html' %}

{% block title %}Cambiar Nota - Profesor{% endblock %}

{% block main_content %}
  <div class="dashboard-header">
    <h1 class="welcome-message">Bienvenido, {{ usuario['nombre'] }}</h1>
  </div>

    <div class="container">
    <h1>Cambiar Nota</h1>

    <form method="POST" action="{{ url_for('cambiar_nota') }}">
      <label for="id_materia">Selecciona una materia:</label>
      <select name="id_materia" id="id_materia" required>
        <option value="" disabled selected>-- Selecciona una materia --</option>
        {% for materia in materias %}
          <option value="{{ materia['id'] }}">{{ materia['nombre'] }}</option>
        {% endfor %}
      </select>
      <button type="submit">Buscar Estudiantes</button>
    </form>

    {% if estudiantes %}
    <form method="POST" action="{{ url_for('cambiar_nota') }}" id="formCambiarNotas">
      <input type="hidden" name="id_materia" value="{{ request.form.get('id_materia') }}">
      
      <table>
        <thead>
          <tr>
            <th>Nombre del Estudiante</th>
            <th>Correo</th>
            <th>Tipo de Nota</th>
            <th>Nota</th>
            <th>Comentario</th>
          </tr>
        </thead>
        <tbody>
          {% for estudiante in estudiantes %}
          <tr>
            <td>{{ estudiante['estudiante'] }}</td>
            <td>{{ estudiante['correo'] }}</td>
            <td>
              <select class="tipo-nota-cambiar-select" name="tipo_nota_cambiar[]" required>
                <option value="" disabled selected>-- Tipo --</option>
                <option value="Parcial 1">Parcial 1</option>
                <option value="Parcial 2">Parcial 2</option>
                <option value="Parcial 3">Parcial 3</option>
                <option value="Quiz">Quiz</option>
                <option value="Tarea">Tarea</option>
                <option value="Proyecto">Proyecto</option>
                <option value="Participación">Participación</option>
                <option value="Examen Final">Examen Final</option>
              </select>
            </td>
            <td>
              <input class="nota-cambiar-input" type="number" name="nueva_nota[]" min="0" max="5" step="0.1" required placeholder="0.0">
              <input type="hidden" name="id_estudiante[]" value="{{ estudiante['id'] }}">
            </td>
            <td>
              <textarea class="comentario-cambiar-textarea" name="comentario[]" rows="2" placeholder="Comentario..."></textarea>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit">Cambiar Nota</button>
    </form>

    {% else %}
      <p>No hay estudiantes inscritos en esta materia.</p>
    {% endif %}

    <a href="{{ url_for('profesor_dashboard') }}" style="text-decoration: none;">
      <button type="button" class="btn-back">Volver</button>
    </a>
  </div>

  {% endblock %}

  {% block extra_scripts %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
        const formCambiarNotas = document.getElementById('formCambiarNotas');

        if (formCambiarNotas) {
          formCambiarNotas.addEventListener('submit', function(e) {
            const notasInputs = document.querySelectorAll('.nota-cambiar-input');
            let tieneAlgunaNota = false;
            notasInputs.forEach(input => {
              if (input.value && parseFloat(input.value) >= 0) {
                tieneAlgunaNota = true;
              }
            });

            if (!tieneAlgunaNota) {
              e.preventDefault();
              alert('Por favor, ingresa al menos una nota');
              return false;
            }
          });
        }
      });
  </script>
  {% endblock %}
